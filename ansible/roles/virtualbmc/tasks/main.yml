---
- name: Set service name
  set_fact:
    service: vbmcd

- name: Check that enough ports are available for Virtual BMC
  fail:
    msg: >
      {{ vbmc_libvirt_domains | count }} nodes were specified to be added to
      Virtual BMC, but only
      {{ vbmc_ipmi_port_range_end - vbmc_ipmi_port_range_start }} ports
      are available for use by Virtual BMC.
  when: >-
      (vbmc_libvirt_domains | count) >
        (vbmc_ipmi_port_range_end - vbmc_ipmi_port_range_start)

- name: Ensure Python requirements are installed
  pip:
    requirements: "{{ '/'.join([role_path, 'files', 'requirements.txt']) }}"
    extra_args: >-
      -c {{ vbmc_python_upper_contraints_url }}
    virtualenv: "{{ vbmc_virtualenv_path }}"

- name: Ensure Virtual BMC systemd service is configured
  template:
    src: templates/{{ item }}.j2
    dest: /etc/systemd/system/{{ item }}
    owner: root
    group: root
    mode: 0644
  become: true
  register: vbmc_service_file
  loop:
    - "{{ service }}.service"

- name: Ensure Virtual BMC systemd service is started and enabled
  systemd:
    name: "{{ service }}"
    enabled: yes
    state: started
    daemon_reload: "{{ vbmc_service_file.changed }}"
  become: true

- include_tasks: domain.yml
  vars:
    domain: "{{ domain }}"
    port: "{{ vbmc_ipmi_port_range_start + port_offset }}"
  loop: "{{ vbmc_libvirt_domains }}"
  loop_control:
    loop_var: domain
    index_var: port_offset
